# 1. 핵심 개념 이해하기

- 노드는 자바스크립트 프로그램을 실행하는 런타임이다.

## 1.1 서버

- 서버란 네트워크를 통해 클라이언트에 정보나 서비스를 제공하는 컴퓨터 또는 프로그램
- 즉 서버는 클라이언트의 요청에 대해 응답한다.
- 노드는 자바스크립트 프로그램이 서버로서 기능하기 위한 도구를 제공한다.
    - 따라서 서버 역할을 수행할 수 있다.

## 1.2 자바스크립트 런타임

- 런타임이란 특정 언어로 만든 프로그램을 실행할 수 있는 환경
    - 즉 노드는 자바스크립트 실행기로 봐도 무방하다
- 2008년 구글이 V8 엔진을 공개했고, 속도가 빨랐기에 라이언 달이 노드 프로젝트에 착수했다.
- 노드는 V8과 더불어 libuv라는 라이브러리를 사용한다.
- libuv 라이브러리는 노드의 특성인 이벤트 기반, 논 블로킹 I/O 모델을 구현하고 있다.

## 1.3 이벤트 기반

- 이벤트 기반(event-driven)이란 이벤트가 발생할 때 미리 지정해둔 작업을 수행하는 방식
    - 이벤트로는 클릭이나 네트워크 요청 등이 있다.
- 이벤트 기반 시스템에서는 특정 이벤트가 발생할 때 뭘 할지 등록해야 한다.
    - 이를 이벤트 리스너에 콜백 함수를 등록한다 표현한다.
- 노드는 이벤트 기반 방식으로 동작한다.
- 이벤트 기반 모델에서는 이벤트 루프(event loop)라는 개념이 등장한다.
- 이벤트 루프는 여러 이벤트가 동시에 발생했을 때 어떤 순서로 콜백 함수를 호출할지 판단한다.
- 노드는 자바스크립트 코드의 제일 처음부터 실행하며, 함수 호출이 이뤄지면 호출 스택(call stack)에 넣는다.
    - `anonymous` 함수는 처음 실행시 전역 컨텍스트를 의미한다.

```javascript
function run() {
    console.log("3초 후 실행");
}
console.log("시작");
setTimeout(run, 3000);
console.log("끝");
```

- 위 코드의 출력 결과를 이해하기 위해선 3가지를 알아야 한다.
    - **이벤트 루프**
        - 이벤트 발생 시 호출할 콜백 함수를 관리하고 호출된 콜백 함수의 실행 순서를 결정하는 역할을 담당한다.
        - 노드가 종료될 때까지 이벤트 처리를 위한 작업을 반복하므로 루프라 부른다.
    - **백그라운드**
        - `setTimeout` 같은 타이머나 이벤트 리스너가 대기하는 곳이다.
        - 자바스크립트가 아닌 다른 언어로 작성된 프로그램이라 볼 수 있다.
        - 여러 작업이 동시에 실행된다.
    - **태스크 큐**
        - 이벤트 발생 후, 백그라운드에서 태스크 큐로 콜백 함수를 보낸다.
        - 정해진 순서대로 콜백들이 줄을 서서 기다려 콜백 큐라고도 부른다.
        - 보통 완료된 순으로 줄을 서나 특정한 경우 바뀌기도 한다.
- 코드의 실행 순서는 다음과 같다.
    - 호출 스택에서 `setTimeout` 실행
    - 백그라운드에 타이머를 등록
    - 타이머가 완료되면 콜백을 태스크 큐에 추가
    - 이벤트 루프가 정해진 규칙에 따라 콜백을 호출 스택으로 추가
- 만약 호출 스택에 함수들이 너무 많이 들어있으면 3초가 지나더라도 `run()`이 실행되지 않을 수 있다.

## 1.4 논 블로킹 I/O

- 작업에는 두 가지 종류가 존재한다.
    - 동시에 실행되는 작업
    - 동시에 실행할 수 없는 작업
- 기본적으로 우리가 작성하는 자바스크립트 코드는 동시에 실행 불가하다.
- 하지만 I/O 작업 같은 것은 동시에 처리될 수 있다.
    - 파일 시스템 접근, 네트워크를 통한 요청 같은 작업
- 이러한 작업을 할 때 노드는 **논 블로킹 방식**으로 처리하는 방법을 제공한다.
    - 논 블로킹: 이전 작업이 완료될 때까지 대기하지 않고 다음 작업을 수행함을 뜻함
- 노드는 I/O 작업을 백그라운드로 넘겨 동시에 처리하곤 한다.
    - 따라서 동시에 처리할 수 있는 작업은 최대한 묶어서 백그라운드로 넘겨야 시간 절약이 가능하다.

```javascript
/** 블로킹 방식 코드 예제 */
function longRunningTask(){
    // 오래 걸리는 작업
    console.log('작업 끝');
}

console.log('시작');
setTimeout(longRunningTask, 0);
console.log('다음 작업');

/* 
    시작
    다음 작업 
    작업 끝
*/
```

- `setTimeout`을 사용해 코드를 논 블로킹으로 만들었다.(원래는 다른 방식이 주로 사용된다.)
    - 하지만 논 블로킹으로 코드를 작성해도 우리가 직접 작성한 것은 전체 소요 시간이 달라지지 않는다.
    - 다만 실행 순서를 바꿔 간단한 작업들이 대기하는 상황을 막을 수 있다는 점에 의의가 있다.
- 동기와 비동기 개념이 있는데, 노드에서는 동기와 블로킹 / 비동기와 논 블로킹이 유사하다.

# 1.5 싱글 스레드

- 엄밀히 말하면 싱글 스레드로 동작하지는 않는다.
- 노드를 실행하면 먼저 프로세스가 생성된다.
- 이 프로세스 안에서 스레드를 생성하는데, 이때 내부적으로 스레드를 여러 개 생성한다.
- 다만 이 안에서 우리가 직접 제어할 수 있는 스레드는 하나 뿐이다.
- 블로킹이 많이 발생할 상황이라면 논 블로킹으로 대기 시간을 줄이는 것이 좋다.
- 다만 스레드풀, 워커 스레드가 있어, 이걸 사용할 땐 싱글 스레드로 동작하지 않는다.

-----
[HOME](./index.md)